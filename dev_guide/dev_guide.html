

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Aide mémoire pour l’utilisation du core de geonature &mdash; GeoNature 2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'2.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html" class="icon icon-home"> GeoNature
          

          
            
            <img src="../_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation-all.html">INSTALLATION GLOBALE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation-standalone.html">INSTALLATION AUTONOME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation-mtes.html">SPECIFICITES DEPOBIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conf-apache.html">CONFIGURATION APACHE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../https.html">HTTPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">CHANGELOG</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GeoNature</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Aide mémoire pour l’utilisation du core de geonature</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev_guide/dev_guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="aide-memoire-pour-l-utilisation-du-core-de-geonature">
<h1>Aide mémoire pour l’utilisation du core de geonature<a class="headerlink" href="#aide-memoire-pour-l-utilisation-du-core-de-geonature" title="Permalink to this headline">¶</a></h1>
<div class="section" id="demarrage-du-serveur-de-dev-backend">
<h2>Démarrage du serveur de dev backend<a class="headerlink" href="#demarrage-du-serveur-de-dev-backend" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>(venv)...$ geonature dev_back
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="base-de-donnees">
<h2>Base de données<a class="headerlink" href="#base-de-donnees" title="Permalink to this headline">¶</a></h2>
<div class="section" id="session-sqlalchemy">
<h3>Session sqlalchemy<a class="headerlink" href="#session-sqlalchemy" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">geonature.utils.env.DB</span></code></li>
</ul>
<p>Fournit l’instance de connexion SQLAlchemy</p>
<p>Python</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="k">import</span> <span class="n">DB</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="serialisation-des-modeles">
<h2>Serialisation des modèles<a class="headerlink" href="#serialisation-des-modeles" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">geonature.utils.utilssqlalchemy.serializable</span></code></li>
</ul>
<p>Décorateur pour les modèles SQLA : Ajoute une méthode as_dict qui retourne un dictionnaire des données de l’objet sérialisable json</p>
<p>Fichier définition modèle</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="k">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">geonature.utils.utilssqlalchemy</span> <span class="k">import</span> <span class="n">serializable</span>

<span class="nd">@serializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>fichier utilisation modele</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">geonature.utils.utilssqlalchemy.geoserializable</span></code></li>
</ul>
<p>Décorateur pour les modèles SQLA : Ajoute une méthode as_geofeature qui retourne un dictionnaire serialisable sous forme de Feature geojson.</p>
<p>Fichier définition modèle</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="k">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">geonature.utils.utilssqlalchemy</span> <span class="k">import</span> <span class="n">geoserializable</span>

<span class="nd">@geoserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>fichier utilisation modele</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_geofeature</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">geonature.utils.utilsgeometry.shapeserializable</span></code></li>
</ul>
<p>Décorateur pour les modèles SQLA:</p>
<ul class="simple">
<li>Ajoute une méthode <code class="docutils literal"><span class="pre">as_list</span></code> qui retourne l’objet sous forme de tableau (utilisé pour créer des shapefiles)</li>
<li>Ajoute une méthode de classe <code class="docutils literal"><span class="pre">to_shape</span></code> qui crée des shapefiles à partir des données passées en paramètre</li>
</ul>
<p>Fichier définition modèle</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="k">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">geonature.utils.utilsgeometry</span> <span class="k">import</span> <span class="n">shapeserializable</span>

<span class="nd">@shapeserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>fichier utilisation modele</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># utilisation de as_shape()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyShapeserializableClass</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">MyShapeserializableClass</span><span class="o">.</span><span class="n">as_shape</span><span class="p">(</span>
    <span class="n">geom_col</span><span class="o">=</span><span class="s1">&#39;geom_4326&#39;</span><span class="p">,</span>
    <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">dir_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="s1">&#39;backend/static/shapefiles&#39;</span><span class="p">),</span>
    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">geonature.utils.utilsgeometry.FionaShapeService</span></code></li>
</ul>
<p>Classe utilitaire pour crer des shapefiles.</p>
<p>La classe contient 3 méthode de classe:
- FionaShapeService.create_shapes_struct(): crée la structure de 3 shapefiles (point, ligne, polygone) à partir des colonens et de la geom passé en paramètre
- FionaShapeService.create_feature(): ajoute un enregistrement aux shapefiles
- FionaShapeService.save_and_zip_shapefiles(): sauvegarde et zip les shapefiles qui ont au moin un enregistrement</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MySQLAModel</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_shapes_struct</span><span class="p">(</span>
                <span class="n">db_cols</span><span class="o">=</span><span class="n">db_cols</span><span class="p">,</span>
                <span class="n">srid</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LOCAL_SRID&#39;</span><span class="p">],</span>
                <span class="n">dir_path</span><span class="o">=</span><span class="n">dir_path</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">col_mapping</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SYNTHESE&#39;</span><span class="p">][</span><span class="s1">&#39;EXPORT_COLUMNS&#39;</span><span class="p">]</span>
        <span class="p">)</span>
<span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_feature</span><span class="p">(</span><span class="n">row_as_dict</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">save_and_zip_shapefiles</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">geonature.utils.utilssqlalchemy.json_resp</span></code></li>
</ul>
<p>Décorateur pour les routes : les données renvoyées par la route sont automatiquement serialisées en json (ou geojson selon la structure des données)</p>
<p>S’insère entre le décorateur de route flask et la signature de fonction</p>
<p>fichier routes</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">geonature.utils.utilssqlalchemy</span> <span class="k">import</span> <span class="n">json_resp</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myerrview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_err_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Not OK&#39;</span><span class="p">},</span> <span class="mi">400</span>
</pre></div>
</div>
</div>
<div class="section" id="export-des-donnees">
<h2>Export des données<a class="headerlink" href="#export-des-donnees" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
</div>
<div class="section" id="authentification-avec-pypnusershub">
<h2>Authentification avec pypnusershub<a class="headerlink" href="#authentification-avec-pypnusershub" title="Permalink to this headline">¶</a></h2>
<div class="section" id="verification-des-droits-des-utilisateurs">
<h3>Vérification des droits des utilisateurs<a class="headerlink" href="#verification-des-droits-des-utilisateurs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pypnusershub.routes.check_auth</span></code></li>
</ul>
<p>Décorateur pour les routes : vérifie les droits de l’utilisateur et le redirige en cas de niveau insuffisant ou d’informations de session erronés
(deprecated) Privilegier <cite>check_auth_cruved</cite></p>
<p>params :</p>
<ul>
<li><p class="first">level &lt;int&gt;: niveau de droits requis pour accéder à la vue</p>
</li>
<li><p class="first">get_role &lt;bool:False&gt;: si True, ajoute l’id utilisateur aux kwargs de la vue</p>
</li>
<li><p class="first">redirect_on_expiration &lt;str:None&gt; : identifiant de vue  sur laquelle rediriger l’utilisateur en cas d’expiration de sa session</p>
</li>
<li><p class="first">redirect_on_invalid_token &lt;str:None&gt; : identifiant de vue sur laquelle rediriger l’utilisateur en cas d’informations de session invalides</p>
<blockquote>
<div><p>from flask import Blueprint
from pypnusershub.routes import check_auth
from geonature.utils.utilssqlalchemy import json_resp</p>
<p>blueprint = Blueprint(__name__)</p>
<p>&#64;blueprint.route(‘/myview’)
&#64;check_auth(</p>
<blockquote>
<div><p>1,
True,
redirect_on_expiration=’my_reconnexion_handler’,
redirect_on_invalid_token=’my_affreux_pirate_handler’
)</p>
</div></blockquote>
<p>&#64;json_resp
def my_view(id_role):</p>
<blockquote>
<div><p>return {‘result’: ‘id_role = {}’.format(id_role)}</p>
</div></blockquote>
</div></blockquote>
</li>
</ul>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pypnusershub.routes.check_auth_cruved</span></code></li>
</ul>
<p>Décorateur pour les routes : Vérifie les droits de l’utilisateur à effectuer une action sur la donnée et le redirige en cas de niveau insuffisant ou d’informations de session erronées</p>
<p>params :</p>
<ul>
<li><p class="first">action &lt;str:[‘C’,’R’,’U’,’V’,’E’,’D’]&gt; type d’action effectuée par la route (Create, Read, Update, Validate, Export, Delete)</p>
</li>
<li><p class="first">get_role &lt;bool:False&gt;: si True, ajoute l’id utilisateur aux kwargs de la vue</p>
</li>
<li><p class="first">redirect_on_expiration &lt;str:None&gt; : identifiant de vue  sur laquelle rediriger l’utilisateur en cas d’expiration de sa session</p>
</li>
<li><p class="first">redirect_on_invalid_token &lt;str:None&gt; : identifiant de vue sur laquelle rediriger l’utilisateur en cas d’informations de session invalides</p>
<blockquote>
<div><p>from flask import Blueprint
from pypnusershub.routes import check_auth_cruved
from geonature.utils.utilssqlalchemy import json_resp</p>
<p>blueprint = Blueprint(__name__)</p>
<p>&#64;blueprint.route(‘/mysensibleview’, methods=[‘GET’])
&#64;check_auth_cruved(</p>
<blockquote>
<div><p>‘R’,
True,
redirect_on_expiration=’my_reconnexion_handler’,
redirect_on_invalid_token=’my_affreux_pirate_handler’
)</p>
</div></blockquote>
<p>&#64;json_resp
def my_sensible_view(id_role):</p>
<blockquote>
<div><p>return {‘result’: ‘id_role = {}’.format(id_role)}</p>
</div></blockquote>
</div></blockquote>
</li>
</ul>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pypnusershub.routes.db.tools.cruved_for_user_in_app</span></code></li>
</ul>
<p>Fonction qui retourne le cruved d’un utilisateur pour une application donnée.
Si aucun cruved n’est définit pour l’application, c’est celui de l’application mère qui est retourné.
Le cruved de l’application enfant surcharge toujours celui de l’application mère.</p>
<p>params:
* id_role &lt;integer:None&gt;
* id_application: id du module surlequel on veut avoir le cruved
* id_application_parent: id l’application parent du module</p>
<p>Valeur retourné: &lt;dict&gt; {‘C’: ‘1’, ‘R’:‘2’, ‘U’: ‘1’, ‘V’:‘2’, ‘E’:‘3’, ‘D’: ‘3’}</p>
<blockquote>
<div><p>from pypnusershub.db.tools import cruved_for_user_in_app</p>
<p>cruved = cruved_for_user_in_app(id_role=5, id_application=18, id_application_parent=14)</p>
</div></blockquote>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, PnE, PnC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>